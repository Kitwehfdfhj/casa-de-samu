<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>دردشة المعلمين - غرفتك الخاصة</title>
<style>
  body{font-family:"Cairo",sans-serif;margin:0;background:linear-gradient(135deg,#000,#111,#555);min-height:100vh;color:#fff;display:flex;flex-direction:column;}
  header{padding:20px;text-align:center;font-size:24px;font-weight:bold}
  .wrap{max-width:820px;margin:20px auto;padding:18px;background:rgba(0,0,0,0.12);border-radius:16px;display:flex;flex-direction:column;height:74vh}
  #meta{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .online-dot{width:10px;height:10px;border-radius:50%;background:#00ff44;display:inline-block}
  .offline-dot{width:10px;height:10px;border-radius:50%;background:#777;display:inline-block}
  #yourName{font-weight:bold}
  #messages{flex:1;overflow:auto;padding:10px;border-radius:10px;background:rgba(0,0,0,0.06)}
  .msg{margin-bottom:10px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.04)}
  .msg.admin{background:rgba(59,130,246,0.08);text-align:left}
  .msg .who{font-size:13px;color:#bbff00;display:block;margin-bottom:4px}
  #typingStatus{height:20px;color:#00eaff;margin:6px 0}
  form{display:flex;gap:8px;margin-top:8px}
  input[type="text"]{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(0,0,0,0.12);color:white;outline:none}
  button{padding:10px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.08);color:white;cursor:pointer}
  #setNameBox{display:flex;gap:8px;margin-bottom:8px}
  #setNameInput{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:white;outline:none}
  .small{font-size:13px;color:#cbd5e1}
</style>
</head>
<body>

<header>دردشة المعلمين — غرفتك الخاصة</header>

<div class="wrap">

  <!-- خانة ضبط الاسم تظهر فقط في أول فتح -->
  <div id="setNameBox" style="display:none">
    <input id="setNameInput" placeholder="أدخل اسمك (مرة واحدة فقط)" />
    <button id="saveNameBtn">حفظ</button>
  </div>

  <div id="meta">
    <span id="statusDot" class="offline-dot"></span>
    <div>
      <div id="yourName" class="small"></div>
      <div id="helpText" class="small">هذه غرفة دردشتك الشخصية — لا يرى الآخرون رسائلك.</div>
    </div>
  </div>

  <div id="messages"></div>
  <div id="typingStatus"></div>

  <form id="chatForm">
    <input type="text" id="chatInput" placeholder="اكتب رسالتك هنا..." autocomplete="off" />
    <button type="submit">إرسال</button>
  </form>
</div>

<!-- صوت إشعار عند استقبال رسالة جديدة من الإدارة -->
<audio id="notifySound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e66a63c16.mp3?filename=notification-113724.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiMs-fSIJi1Jwi6_BSddsmCZ5GXatdcEA",
  authDomain: "casa-7bc46.firebaseapp.com",
  databaseURL: "https://casa-7bc46-default-rtdb.firebaseio.com",
  projectId: "casa-7bc46",
  storageBucket: "casa-7bc46.firebasestorage.app",
  messagingSenderId: "464116381670",
  appId: "1:464116381670:web:03d98f8aeea6769d4b8827"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* عناصر DOM */
const setNameBox = document.getElementById("setNameBox");
const setNameInput = document.getElementById("setNameInput");
const saveNameBtn = document.getElementById("saveNameBtn");
const yourNameEl = document.getElementById("yourName");
const statusDot = document.getElementById("statusDot");
const messagesDiv = document.getElementById("messages");
const chatForm = document.getElementById("chatForm");
const chatInput = document.getElementById("chatInput");
const typingStatus = document.getElementById("typingStatus");
const notifySound = document.getElementById("notifySound");

let chatId = localStorage.getItem("chatId");
let chatName = localStorage.getItem("chatName");

// إذا لم يوجد اسم/معرّف — نعرض مربع الإدخال
if(!chatId || !chatName){
  setNameBox.style.display = "flex";
} else {
  setNameBox.style.display = "none";
  yourNameEl.textContent = chatName;
}

// عند حفظ الاسم للمرة الأولى
saveNameBtn.addEventListener("click", async () => {
  const v = setNameInput.value.trim();
  if(!v){ alert("اكتب اسمك"); return; }
  // إنشاء معرّف فريد محلي
  chatId = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  chatName = v;
  localStorage.setItem("chatId", chatId);
  localStorage.setItem("chatName", chatName);
  setNameBox.style.display = "none";
  yourNameEl.textContent = chatName;

  // تحديث حالة المستخدم في DB
  await set(ref(db, "users/" + chatId), { name: chatName, online: true });
  updateStatusDot(true);
  startListening();
});

// لو الاسم محفوظ مسبقًا: نفعّل الاستماع
if(chatId && chatName){
  // وضع الحالة أونلاين
  set(ref(db, "users/" + chatId), { name: chatName, online: true });
  updateStatusDot(true);
  startListening();
}

// عند الخروج من الصفحة: وضع أونلاين = false
window.addEventListener("beforeunload", () => {
  if(chatId) set(ref(db, "users/" + chatId), { name: chatName, online: false });
  // وضع typing = false
  if(chatId) set(ref(db, "typing/" + chatId), { typing: false });
});

// تحديث نقطة الأونلاين
function updateStatusDot(isOnline){
  statusDot.className = isOnline ? "online-dot" : "offline-dot";
}

// — typing: نرسل حالة الكتابة عندما يكتب المستخدم
let typingTimer = null;
chatInput.addEventListener("input", () => {
  if(!chatId) return;
  set(ref(db, "typing/" + chatId), { typing: chatInput.value.length > 0 });
  if(typingTimer) clearTimeout(typingTimer);
  typingTimer = setTimeout(()=> {
    set(ref(db, "typing/" + chatId), { typing: false });
  }, 1200);
});

// الاستماع لحالة typing ليست ضرورية للمستخدم لأنه غرفة خاصة، لكن الإدارة قد تشاهدها.
// نستمع لحالة typing لأي رد من الإدارة (ليعرض "الإدارة تكتب..." إذا رغبت)
onValue(ref(db, "typing"), (snap) => {
  // إذا كان هناك typing في غرفتنا من الـ Admin (نستخدم convention: admin لا يضع typing هنا)
  // فلنظهر نص فقط إن وجد typing للـ chatId ومنه قيمة true
  if(!chatId) return;
  const val = snap.child(chatId).val();
  if(val && val.typing) typingStatus.textContent = "الإدارة تكتب...";
  else typingStatus.textContent = "";
});

let lastCount = 0;

// الاستماع لرسائل غرفتنا فقط
function startListening(){
  if(!chatId) return;
  const roomRef = ref(db, "chatMessages/" + chatId);
  onValue(roomRef, (snapshot) => {
    messagesDiv.innerHTML = "";
    let count = 0;
    snapshot.forEach(child => {
      count++;
      const m = child.val();
      const div = document.createElement("div");
      div.className = "msg " + (m.from === "admin" ? "admin" : "user");
      const who = document.createElement("span");
      who.className = "who";
      who.textContent = m.from === "admin" ? (m.name || "الإدارة") : (m.name || chatName);
      div.appendChild(who);
      const txt = document.createElement("div");
      txt.innerHTML = m.text;
      div.appendChild(txt);
      messagesDiv.appendChild(div);
    });

    // تشغيل صوت فقط عند وصول رسالة جديدة ليست من نفس المستخدم (أي من admin)
    if(count > lastCount){
      // الحصول على آخر رسالة لمعرفة المرسل
      const last = snapshot.val() ? Object.values(snapshot.val())[Object.values(snapshot.val()).length -1] : null;
      if(last && last.from === "admin"){
        notifySound.play();
      }
    }
    lastCount = count;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// إرسال رسالة (من المستخدم، تذهب إلى غرفته)
chatForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if(!chatId || !chatName) { alert("يجب تسجيل الاسم أولاً"); return; }
  const txt = chatInput.value.trim();
  if(!txt) return;
  const roomRef = ref(db, "chatMessages/" + chatId);
  await push(roomRef, {
    text: txt,
    from: "user",
    name: chatName,
    timestamp: Date.now()
  });
  chatInput.value = "";
});

</script>
</body>
</html>
