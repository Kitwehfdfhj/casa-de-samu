<!doctype html>
<html lang="es" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title id="pageTitle">Panel de Administraci√≥n ‚Äî Salas de usuarios</title>
<style>
  body{font-family:"Cairo",sans-serif;margin:0;background:linear-gradient(135deg,#0f172a,#1e293b);min-height:100vh;color:#fff}
  #container{display:flex;gap:18px;max-width:1100px;margin:22px auto;padding:18px}
  #left{width:340px;background:rgba(255,255,255,0.03);border-radius:12px;padding:14px}
  #right{flex:1;background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;display:flex;flex-direction:column;height:80vh}
  h3{margin:4px 0 8px 0}
  .userItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer;position:relative}
  .userItem:hover{background:rgba(255,255,255,0.02)}
  .userLeft{display:flex;gap:10px;align-items:center}
  .online-dot{width:10px;height:10px;border-radius:50%;background:#00ff44}
  .offline-dot{width:10px;height:10px;border-radius:50%;background:#777}
  .userMeta{display:flex;flex-direction:column}
  .lastSeen{font-size:11px;color:#9aa4b2}
  .badge-unread{background:#ef4444;color:white;border-radius:12px;padding:3px 8px;font-size:12px;margin-left:8px}
  #messagesArea{flex:1;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.06)}
  .msg{margin-bottom:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03)}
  .msg.admin{background:rgba(59,130,246,0.08);text-align:left}
  .msg .who{font-size:13px;color:#0ea5a2;margin-bottom:6px;display:block}
  #adminControls{display:flex;gap:8px;margin-top:8px}
  textarea{width:100%;height:80px;border-radius:8px;padding:8px;border:none;background:rgba(255,255,255,0.04);color:white;resize:none}
  button{padding:10px 14px;border-radius:8px;border:none;background:#2563eb;color:white;cursor:pointer}
  button.clear{background:#ef4444}
  .meta{font-size:12px;color:#cbd5e1}
  .smallMuted{font-size:12px;color:#9aa4b2}
</style>
</head>
<body>

<!-- Audio para notificaci√≥n -->
<audio id="msgSound">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3" type="audio/mpeg">
</audio>

<!-- Contenedor -->
<div id="container">
  <div id="left">
    <h3>Lista de usuarios</h3>
    <div id="usersList" style="max-height:76vh;overflow:auto"></div>
  </div>

  <div id="right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 id="roomTitle">Selecciona un usuario para ver su sala</h3>
        <div id="roomSub" class="meta"></div>
      </div>
      <div>
        <button id="logoutBtn">Salir</button>
      </div>
    </div>

    <div id="messagesArea"></div>

    <div id="typingIndicator" style="color:#00eaff;height:20px;margin-top:6px"></div>

    <div id="adminControls">
      <textarea id="adminReply" placeholder="Escribe la respuesta de la Administraci√≥n..."></textarea>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="sendReplyBtn">Enviar respuesta</button>
        <button id="clearRoomBtn" class="clear">Borrar sala</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
/*
  admin.html (ES) - versi√≥n ŸÖÿµÿ≠Ÿëÿ≠ÿ©
  - Corrige errores de sintaxis y cierres faltantes.
  - A√±ade listener correcto para logoutBtn.
  - Mantiene la l√≥gica original de unread/lastSeen/mensajes.
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiMs-fSIJi1Jwi6_BSddsmCZ5GXatdcEA",
  authDomain: "casa-7bc46.firebaseapp.com",
  databaseURL: "https://casa-7bc46-default-rtdb.firebaseio.com",
  projectId: "casa-7bc46",
  storageBucket: "casa-7bc46.firebasestorage.app",
  messagingSenderId: "464116381670",
  appId: "1:464116381670:web:03d98f8aeea6769d4b8827"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const usersList = document.getElementById("usersList");
const roomTitle = document.getElementById("roomTitle");
const roomSub = document.getElementById("roomSub");
const messagesArea = document.getElementById("messagesArea");
const adminReply = document.getElementById("adminReply");
const sendReplyBtn = document.getElementById("sendReplyBtn");
const typingIndicator = document.getElementById("typingIndicator");
const clearRoomBtn = document.getElementById("clearRoomBtn");
const logoutBtn = document.getElementById("logoutBtn");
const audio = document.getElementById("msgSound");
const pageTitle = document.getElementById("pageTitle");

let selectedUserId = null;
let selectedUserName = null;
let swRegistration = null;
let unreadListeners = {}; // listeners per user (prevent duplicate)
let lastMessageTimestamp = 0;

/* Register service worker (SW) to enable notifications + background when using FCM */
if ('serviceWorker' in navigator) {
  // intenta registrar; si no existe sw.js no interrumpe la ejecuci√≥n
  navigator.serviceWorker.register('/sw.js').then(reg => {
    console.log('Service Worker registrado', reg);
    swRegistration = reg;
  }).catch(err => {
    console.warn('No se pudo registrar Service Worker (posible ausencia de /sw.js):', err);
  });
}

// Solicitar permiso de notificaciones al cargar
if (Notification && Notification.permission !== "granted") {
  Notification.requestPermission().catch(()=>{});
}

/* ---------- FUNCIONES DE NOTIFICACI√ìN ---------- */

let flashing = false;
let flashInterval = null;
function startFlash(badgeCount = 0){
  if(flashing) return;
  flashing = true;
  const original = document.title;
  let toggle = false;
  flashInterval = setInterval(()=>{
    if(!flashing){ clearInterval(flashInterval); document.title = original; return; }
    document.title = toggle ? `üì© (${badgeCount}) Nuevos mensajes` : original;
    toggle = !toggle;
  }, 700);
}
function stopFlash(){
  flashing = false;
  if(flashInterval) { clearInterval(flashInterval); flashInterval = null; }
}

function showDesktopNotification(title, body){
  try {
    if(!("Notification" in window)) return;
    if(Notification.permission === "granted"){
      if(swRegistration && typeof swRegistration.showNotification === 'function'){
        swRegistration.showNotification(title, {
          body,
          icon: "https://cdn-icons-png.flaticon.com/512/889/889140.png",
          tag: 'chat-notif'
        }).catch(()=> {
          // fallback
          new Notification(title, { body, icon: "https://cdn-icons-png.flaticon.com/512/889/889140.png" });
        });
      } else {
        new Notification(title, { body, icon: "https://cdn-icons-png.flaticon.com/512/889/889140.png" });
      }
    }
  } catch(e){ console.warn("Notif error:", e); }
}

// reproducir sonido
function playSound(){ 
  try{ audio.currentTime = 0; audio.play(); } catch(e){} 
}

/* ---------- L√ìGICA DE LISTA DE USUARIOS / UNREAD / LASTSEEN ---------- */

/*
  Estructura en la DB esperada:
  - users/{uid} => { name, online: true/false, lastSeen: timestamp }
  - chatMessages/{uid}/{msgId} => { text, from: "user"|"admin", name, timestamp }
  - unread/{uid}/count => number
*/

const usersRef = ref(db, "users");

// leer lista de usuarios y construir UI
onValue(usersRef, (snap) => {
  usersList.innerHTML = "";

  snap.forEach(child => {
    const u = child.val() || {};
    const id = child.key;

    // crear elemento
    const div = document.createElement("div");
    div.className = "userItem";
    div.id = `user-${id}`;

    const lastSeen = u.lastSeen ? new Date(u.lastSeen).toLocaleString() : "sin actividad";

    div.innerHTML = `
      <div class="userLeft">
        <span class="${u.online ? 'online-dot' : 'offline-dot'}"></span>
        <div class="userMeta">
          <div style="font-weight:bold">${u.name || id}</div>
          <div class="lastSeen">√ölt. actividad: ${lastSeen}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div id="badge-${id}"></div>
        <button data-id="${id}" class="openBtn">Abrir</button>
      </div>
    `;
    usersList.appendChild(div);

    // escuchar unread count de este usuario y actualizar badge
    const unreadRef = ref(db, `unread/${id}/count`);
    onValue(unreadRef, (uSnap) => {
      const count = uSnap.val() || 0;
      const badgeEl = document.getElementById(`badge-${id}`);
      if(!badgeEl) return;
      badgeEl.innerHTML = count > 0 ? `<span class="badge-unread">${count}</span>` : '';
      updateGlobalUnreadBadge();
    });

    // attach listener para nuevo mensaje en la sala (si no existe a√∫n)
    if(!unreadListeners[id]){
      const roomRef = ref(db, `chatMessages/${id}`);
      onValue(roomRef, (roomSnap) => {
        // buscamos el √∫ltimo mensaje (por timestamp)
        let lastTs = 0;
        let lastMsg = null;
        roomSnap.forEach(mch => {
          const m = mch.val();
          if(m && m.timestamp && m.timestamp > lastTs){
            lastTs = m.timestamp;
            lastMsg = m;
          }
        });
        // si hay mensaje nuevo y no estamos en la sala seleccionada => incrementar unread
        if(lastMsg && lastMsg.from !== "admin"){
          if(selectedUserId !== id){
            const unreadCountRef = ref(db, `unread/${id}/count`);
            runTransaction(unreadCountRef, (current) => {
              return (current || 0) + 1;
            }).then(()=> {
              showDesktopNotification("Nuevo mensaje", `${lastMsg.name || 'Usuario'}: ${truncateText(lastMsg.text, 80)}`);
              playSound();
              startFlash();
            }).catch(()=>{ /* ignore */ });
          }
        }
      });
      unreadListeners[id] = true;
    }
  });

  // conectar botones "Abrir"
  const openBtns = usersList.querySelectorAll(".openBtn");
  openBtns.forEach(b => {
    b.onclick = () => {
      const id = b.getAttribute("data-id");
      selectRoom(id);
    };
  });
});

// funci√≥n helper truncar
function truncateText(s, n){
  if(!s) return "";
  return s.length > n ? s.slice(0,n-1) + '‚Ä¶' : s;
}

/* actualizar badge global (suma de todos unread) */
function updateGlobalUnreadBadge(){
  const allBadges = document.querySelectorAll('[id^="badge-"] .badge-unread');
  let sum = 0;
  allBadges.forEach(el => sum += parseInt(el.textContent || '0'));
  if(sum > 0){
    startFlash(sum);
  } else {
    stopFlash();
  }
}

/* seleccionar sala */
function selectRoom(id){
  selectedUserId = id;
  // reset unread for this user
  set(ref(db, `unread/${id}/count`), 0).catch(()=>{});
  // cargar mensajes
  listenRoom(id);
  listenTyping(id);
  // actualizar t√≠tulos
  const userName = document.querySelector(`#user-${id} .userMeta div:first-child`)?.textContent || id;
  selectedUserName = userName;
  roomTitle.textContent = `Sala: ${selectedUserName}`;
  roomSub.textContent = `Usuario: ${id}`;
  // reset local lastMessageTimestamp para evitar notificaciones duplicadas
  lastMessageTimestamp = 0;
  stopFlash();
}

/* ESCUCHAR MENSAJES DE UNA SALA */
function listenRoom(userId){
  messagesArea.innerHTML = "";
  const roomRef = ref(db, "chatMessages/" + userId);
  onValue(roomRef, (snap) => {
    messagesArea.innerHTML = "";
    let newestTs = lastMessageTimestamp || 0;
    snap.forEach(child => {
      const m = child.val();
      // seguridad: omitir nodes inv√°lidos
      if(!m || !m.text) return;
      const d = document.createElement("div");
      d.className = "msg " + (m.from === "admin" ? "admin" : "user");
      d.innerHTML = `<span class="who">${m.from === 'admin' ? 'Administraci√≥n' : (m.name || 'Usuario')}</span>
                     <div>${escapeHtml(m.text)}</div>
                     <div style="font-size:11px;color:#9aa4b2;margin-top:6px">${m.timestamp ? new Date(m.timestamp).toLocaleString() : ''}</div>`;
      messagesArea.appendChild(d);
      if(m.timestamp && m.timestamp > newestTs) newestTs = m.timestamp;
    });
    messagesArea.scrollTop = messagesArea.scrollHeight;

    // establecer lastMessageTimestamp
    lastMessageTimestamp = newestTs;
  });
}

/* ESCUCHAR TYPING */
function listenTyping(userId){
  const tRef = ref(db, `typing/${userId}`);
  onValue(tRef, (snap) => {
    const val = snap.val();
    typingIndicator.textContent = val && val.typing ? "‚Ä¶est√° escribiendo" : "";
  });
}

/* ENVIAR RESPUESTA */
sendReplyBtn.onclick = async () => {
  if(!selectedUserId) return alert("Elige un usuario");
  const txt = adminReply.value.trim();
  if(!txt) return alert("Escribe la respuesta primero");
  await push(ref(db, `chatMessages/${selectedUserId}`), {
    text: txt,
    from: "admin",
    name: "Administraci√≥n",
    timestamp: Date.now()
  });
  // reset unread y typing
  set(ref(db, `unread/${selectedUserId}/count`), 0).catch(()=>{});
  set(ref(db, `typing/${selectedUserId}`), { typing: false }).catch(()=>{});
  adminReply.value = "";
  stopFlash();
};

/* BORRAR SALA */
clearRoomBtn.onclick = () => {
  if(!selectedUserId) return alert("Elige un usuario");
  if(!confirm("¬øEliminar todos los mensajes de esta sala?")) return;
  remove(ref(db, `chatMessages/${selectedUserId}`)).catch(()=>{});
  set(ref(db, `unread/${selectedUserId}/count`), 0).catch(()=>{});
};

/* BOT√ìN SALIR (redirige a index.html) */
logoutBtn.addEventListener("click", () => {
  // si quieres que haga logout real (Firebase Auth) reemplaza por l√≥gica de auth
  window.location.href = "index.html";
});

/* ---------- UTILS / INICIALIZACION ---------- */

// escapar texto para evitar inyectar HTML
function escapeHtml(unsafe) {
  return unsafe
   .replaceAll('&', "&amp;")
   .replaceAll('<', "&lt;")
   .replaceAll('>', "&gt;")
   .replaceAll('"', "&quot;")
   .replaceAll("'", "&#039;");
}

// Cuando carga la p√°gina, actualizamos el badge global
updateGlobalUnreadBadge();

/*
  NOTA SOBRE PUSH: Para recibir notificaciones con la pesta√±a cerrada necesitas
  configurar Firebase Cloud Messaging (FCM) y un backend que env√≠e push.
*/

</script>
</body>
</html>
