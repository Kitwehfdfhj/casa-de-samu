<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>لوحة الإدارة — توزيع المهام</title>

<style>
  body{
    font-family:"Cairo",sans-serif;
    margin:0;
    background: linear-gradient(135deg, #0f172a, #1e293b, #3b82f6);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  #loginBox{
    width:500px;
    background:rgba(255,255,255,0.05);
    padding:50px 40px;
    border-radius:25px;
    backdrop-filter:blur(20px);
    -webkit-backdrop-filter:blur(20px);
    box-shadow:0 20px 60px rgba(0,0,0,0.5);
    animation:fadeIn .8s ease-out;
    text-align:center;
    border: 1px solid rgba(255,255,255,0.2);
  }

  #loginBox h3{
    color:#f1f5f9;
    font-size:32px;
    margin-bottom:30px;
    text-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }

  #loginBox input{
    width:100%;
    padding:16px;
    margin-top:16px;
    font-size:18px;
    border-radius:12px;
    border:none;
    background:rgba(255,255,255,0.1);
    color:white;
    outline:none;
    transition:.3s;
    box-sizing:border-box;
  }

  #loginBox input:focus{
    background:rgba(255,255,255,0.2);
    box-shadow: 0 0 12px rgba(255,255,255,0.4);
  }

  #loginBox input::placeholder{
    color:rgba(255,255,255,0.6);
    text-align:center;
  }

  #loginBox button{
    width:100%;
    padding:16px;
    border:0;
    border-radius:12px;
    background: #3b82f6;
    color:white;
    font-size:18px;
    font-weight:bold;
    margin-top:20px;
    cursor:pointer;
    transition:.3s;
    box-shadow:0 5px 15px rgba(0,0,0,0.2);
  }

  #loginBox button:hover{
    background:#2563eb;
    transform:scale(1.05);
    box-shadow:0 8px 20px rgba(0,0,0,0.3);
  }

  #loginError{
    margin-top:14px;
    color:#f87171;
    font-size:16px;
    font-weight:bold;
  }

  #adminArea{ display:none; }

  header{color:white;padding:16px;text-align:center}
  .wrap{max-width:1000px;margin:20px auto;padding:8px}
  .card{background:white;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.07)}
  input,textarea,select{width:90%;padding:8px;margin-top:8px;border-radius:8px;border:1px solid #cbd5e1}
  button{padding:10px 18px;border:0;border-radius:8px;background:#2563eb;color:white;cursor:pointer}
  .danger{background:#ef4444}
  .person{padding:8px;background:#f8fafc;border-radius:8px;margin-bottom:6px}

  @keyframes fadeIn{
    from{opacity:0; transform:translateY(20px);}
    to{opacity:1; transform:translateY(0);}
  }
</style>
</head>
<body>

<!-- واجهة تسجيل الدخول -->
<div id="loginBox">
  <h3>Inicio de sesión de administrador</h3>
  <input id="email" placeholder="email">
  <input id="password" type="password" placeholder="password">
  <button id="loginBtn">login</button>
  <div id="loginError"></div>
</div>

<!-- لوحة الإدارة -->
<div id="adminArea">
<header><h2>Panel de administración</h2></header>

<div class="wrap">

  <div class="card">
    hola : <strong id="adminEmail"></strong>
    <button id="logoutBtn" class="danger" style="float:left">salida</button>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">

    <!-- الأشخاص -->
    <div class="card">
      <h3>personas</h3>
      <div id="peopleList"></div>
      <hr>
      <h4>Agregar una persona</h4>
      <input id="newPersonName" placeholder="Nombre de la persona">
      <button id="addPersonBtn" style="margin-top:8px">suma</button>
    </div>

    <!-- المهام -->
    <div class="card">
      <h3>Crear una tarea</h3>
      <select id="assignTo"></select>
      <textarea id="taskText" rows="3" placeholder="una descripción"></textarea>
      <input type="date" id="taskDate">
      <button id="createTaskBtn" style="margin-top:8px">Crear</button>

      <hr>
      <h4>Tareas actuales</h4>
      <div id="tasksList"></div>
    </div>

    <!-- قسم الرسائل -->
    <div class="card">
      <h3>رسائل المعلمين</h3>
      <div id="chatMessagesList" style="max-height:300px;overflow-y:auto;margin-bottom:10px;"></div>
      <textarea id="adminReply" rows="2" placeholder="اكتب ردك هنا..."></textarea>
      <button id="sendReplyBtn" style="margin-top:6px">إرسال الرد</button>
    </div>

  </div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCiMs-fSIJi1Jwi6_BSddsmCZ5GXatdcEA",
  authDomain: "casa-7bc46.firebaseapp.com",
  databaseURL: "https://casa-7bc46-default-rtdb.firebaseio.com",
  projectId: "casa-7bc46",
  storageBucket: "casa-7bc46.firebasestorage.app",
  messagingSenderId: "464116381670",
  appId: "1:464116381670:web:03d98f8aeea6769d4b8827",
  measurementId: "G-G7XZBBQH10"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* عناصر HTML */
const loginBox = document.getElementById("loginBox");
const adminArea = document.getElementById("adminArea");
const loginBtn = document.getElementById("loginBtn");
const loginError = document.getElementById("loginError");
const email = document.getElementById("email");
const password = document.getElementById("password");
const adminEmail = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

const peopleList = document.getElementById("peopleList");
const tasksList = document.getElementById("tasksList");
const newPersonName = document.getElementById("newPersonName");
const addPersonBtn = document.getElementById("addPersonBtn");
const taskText = document.getElementById("taskText");
const assignTo = document.getElementById("assignTo");
const createTaskBtn = document.getElementById("createTaskBtn");
const taskDate = document.getElementById("taskDate");

const chatMessagesList = document.getElementById("chatMessagesList");
const adminReply = document.getElementById("adminReply");
const sendReplyBtn = document.getElementById("sendReplyBtn");

/* تسجيل الدخول */
loginBtn.onclick = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
  .then(() => {
    loginBox.style.display = "none";
    adminArea.style.display = "block";
    adminEmail.textContent = auth.currentUser.email;
  })
  .catch(err => {
    loginError.textContent = "خطأ: البريد أو كلمة المرور غير صحيحة";
  });
};

/* تسجيل الخروج */
logoutBtn.onclick = () => {
  signOut(auth);
  adminArea.style.display = "none";
  loginBox.style.display = "block";
};

/* إضافة شخص */
addPersonBtn.onclick = () => {
  const name = newPersonName.value.trim();
  if (!name) return alert("أدخل اسم الشخص");
  const personRef = push(ref(db, "people"));
  set(personRef, { name });
  newPersonName.value = "";
};

/* قراءة الأشخاص */
onValue(ref(db, "people"), (snapshot) => {
  peopleList.innerHTML = "";
  assignTo.innerHTML = "";
  snapshot.forEach((child) => {
    const data = child.val();
    const id = child.key;
    const div = document.createElement("div");
    div.className = "person";
    div.textContent = data.name;
    peopleList.appendChild(div);
    const option = document.createElement("option");
    option.value = id;
    option.textContent = data.name;
    assignTo.appendChild(option);
  });
});

/* إنشاء مهمة مع التاريخ */
createTaskBtn.onclick = () => {
  const text = taskText.value.trim();
  const personId = assignTo.value;
  const personName = assignTo.options[assignTo.selectedIndex].text;
  const dateValue = taskDate.value;
  if (!text) return alert("أدخل نص المهمة");
  if (!dateValue) return alert("اختر تاريخ المهمة");
  const taskRef = push(ref(db, "tasks"));
  set(taskRef, { title: text, assigneeId: personId, assigneeName: personName, date: dateValue });
  taskText.value = "";
  taskDate.value = "";
};

/* قراءة المهام */
onValue(ref(db, "tasks"), (snapshot) => {
  tasksList.innerHTML = "";
  snapshot.forEach((child) => {
    const t = child.val();
    const id = child.key;
    const div = document.createElement("div");
    div.innerHTML = `
      <strong>${t.title}</strong>
      <div style="color:#666">لـ ${t.assigneeName}</div>
      <div style="color:#999;font-size:14px">تاريخ: ${t.date}</div>
      <button onclick="deleteTask('${id}')">حذف</button>
    `;
    tasksList.appendChild(div);
  });
});

window.deleteTask = (id) => {
  remove(ref(db, "tasks/" + id));
};

/* قراءة الرسائل وعرض الردود */
onValue(ref(db, "chatMessages"), (snapshot) => {
  chatMessagesList.innerHTML = "";
  snapshot.forEach((child) => {
    const msg = child.val();
    const div = document.createElement("div");
    div.style.padding = "8px";
    div.style.borderBottom = "1px solid rgba(0,0,0,0.1)";
    div.innerHTML = `<strong>${msg.name || "معلم"}:</strong> ${msg.text}`;
    if(msg.reply){
      const replyDiv = document.createElement("div");
      replyDiv.style.color = "#3b82f6";
      replyDiv.style.fontSize = "14px";
      replyDiv.style.marginTop = "4px";
      replyDiv.textContent = `رد الإدارة: ${msg.reply.text}`;
      div.appendChild(replyDiv);
    }
    chatMessagesList.appendChild(div);
  });
  chatMessagesList.scrollTop = chatMessagesList.scrollHeight;
});

/* إرسال الرد */
sendReplyBtn.onclick = () => {
  const replyText = adminReply.value.trim();
  if(!replyText) return alert("اكتب الرد أولاً");
  const lastMsgRef = ref(db, "chatMessages");
  onValue(lastMsgRef, (snapshot) => {
    let lastKey = null;
    snapshot.forEach(child => { lastKey = child.key });
    if(lastKey){
      set(ref(db, "chatMessages/" + lastKey + "/reply"), {
        text: replyText,
        admin: auth.currentUser.email,
        timestamp: Date.now()
      });
      adminReply.value = "";
      alert("تم إرسال الرد");
    }
  }, {onlyOnce:true});
};
</script>

</body>
</html>
